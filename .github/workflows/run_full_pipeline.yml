name: Rust LOC + COSMIC CFP Full Pipeline
on:
  workflow_dispatch:

jobs:
  full_pipeline:
    runs-on: ubuntu-latest

    steps:
      # --- Checkout repository ---
      - uses: actions/checkout@v4

      # --- Install system and Python dependencies ---
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip git curl jq
          pip3 install matplotlib pandas numpy

      # --- Install Rust LOC analyzer (tokei) ---
      - name: Install tokei
        run: cargo install tokei

      # --- Prepare workspace ---
      - run: mkdir -p work

      # --- Fetch Top ~100 Rust repositories (Rust-major) ---
      - name: Fetch top Rust repositories (≥90% Rust, top 100 approx)
        run: |
          rm -f repos.txt
          for page in {1..2}; do  # each page ~50 repos → total ~100
            curl -s "https://api.github.com/search/repositories?q=language:Rust&sort=stars&order=desc&page=$page&per_page=50" \
            | jq -r '.items[].full_name' >> repos.txt
            sleep 2
          done
          echo "Total repos (initial): $(wc -l < repos.txt)"
          
          # Verify repos actually contain mostly Rust (≥90% Rust LOC)
          echo "" > filtered_repos.txt
          while read -r repo; do
            langs=$(curl -s "https://api.github.com/repos/$repo/languages")
            rust=$(echo "$langs" | jq '.Rust // 0')
            total=$(echo "$langs" | jq 'map(.) | add // 1')
            ratio=$((100 * rust / total))
            if [ "$ratio" -ge 90 ]; then
              echo "$repo" >> filtered_repos.txt
            fi
          done < repos.txt

          mv filtered_repos.txt repos.txt
          echo "Total repos after ≥90% Rust filter: $(wc -l < repos.txt)"

      # --- Clone, analyze, then delete each repo to save space ---
      - name: Analyze LOC with tokei
        run: |
          echo "repo,rust_code,files,comments,blanks" > rust_loc_results.csv
          while read -r repo; do
            [[ -z "$repo" ]] && continue
            echo "Processing $repo..."
            dir="work/$(echo "$repo" | tr / _)"
            
            git clone --depth 1 --single-branch --no-tags "https://github.com/$repo.git" "$dir" --quiet || continue

            # ✅ Correct way to count Rust-only LOC
            tokei "$dir" -t Rust --output json > "$dir/tokei.json"

            python3 scripts/parse_tokei.py "$repo" "$dir/tokei.json" >> rust_loc_results.csv

            # ✅ Free disk space immediately
            rm -rf "$dir"
          done < repos.txt

      # --- Compute COSMIC CFP ---
      - name: Compute COSMIC CFP
        run: python3 scripts/analyze_loc_cfp.py

      # --- Generate statistical plots ---
      - name: Generate plots
        run: python3 scripts/plot_results.py

      # --- Upload all results ---
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rust-loc-cfp-artifacts
          path: |
            rust_loc_results_with_summary.csv
            hist_eloc_per_cfp.png
            scatter_eloc_vs_cfp.png
            box_by_type.png
